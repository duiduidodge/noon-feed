name: Deploy Worker (Fly)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "apps/worker/**"
      - "packages/shared/**"
      - "prisma/**"
      - "config/**"
      - "scripts/start-worker.sh"
      - "Dockerfile.worker"
      - "fly.worker.toml"
      - ".github/workflows/deploy-worker-fly.yml"

concurrency:
  group: deploy-worker-fly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      APP_NAME: noon-feed-worker
      CONFIG_FILE: fly.worker.toml
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_WORKER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@fc53c09e1bc3be6f54706524e3b82c4f462f77be

      - name: Validate required secrets
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
        run: |
          for key in FLY_API_TOKEN DATABASE_URL DIRECT_URL; do
            if [ -z "${!key:-}" ]; then
              echo "::error::Missing required GitHub secret: ${key}"
              exit 1
            fi
          done

      - name: Sync worker secrets
        continue-on-error: true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SENPI_AUTH_TOKEN: ${{ secrets.SENPI_AUTH_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          DASHBOARD_AUTH_SECRET: ${{ secrets.DASHBOARD_AUTH_SECRET }}
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
          LLM_MODEL: ${{ vars.LLM_MODEL }}
          FETCH_INTERVAL_MINUTES: ${{ vars.FETCH_INTERVAL_MINUTES }}
          WORKER_CONCURRENCY: ${{ vars.WORKER_CONCURRENCY }}
          SKIP_ENRICHMENT: ${{ vars.SKIP_ENRICHMENT }}
          ENABLE_HIGH_IMPACT_POSTING: ${{ vars.ENABLE_HIGH_IMPACT_POSTING }}
          AUTO_POST_TO_DISCORD: ${{ vars.AUTO_POST_TO_DISCORD }}
          ENABLE_WHALE_SIGNALS: ${{ vars.ENABLE_WHALE_SIGNALS }}
          WHALE_SIGNALS_INTERVAL_SECONDS: ${{ vars.WHALE_SIGNALS_INTERVAL_SECONDS }}
          WHALE_RISK_PROFILE: ${{ vars.WHALE_RISK_PROFILE }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
          NODE_ENV: production
        run: |
          cat > /tmp/worker-secrets.env <<EOF
          DATABASE_URL=${DATABASE_URL}
          DIRECT_URL=${DIRECT_URL}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
          OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
          SENPI_AUTH_TOKEN=${SENPI_AUTH_TOKEN}
          DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
          DASHBOARD_AUTH_SECRET=${DASHBOARD_AUTH_SECRET}
          LLM_PROVIDER=${LLM_PROVIDER}
          LLM_MODEL=${LLM_MODEL}
          FETCH_INTERVAL_MINUTES=${FETCH_INTERVAL_MINUTES}
          WORKER_CONCURRENCY=${WORKER_CONCURRENCY}
          SKIP_ENRICHMENT=${SKIP_ENRICHMENT}
          ENABLE_HIGH_IMPACT_POSTING=${ENABLE_HIGH_IMPACT_POSTING}
          AUTO_POST_TO_DISCORD=${AUTO_POST_TO_DISCORD}
          ENABLE_WHALE_SIGNALS=${ENABLE_WHALE_SIGNALS}
          WHALE_SIGNALS_INTERVAL_SECONDS=${WHALE_SIGNALS_INTERVAL_SECONDS}
          WHALE_RISK_PROFILE=${WHALE_RISK_PROFILE}
          LOG_LEVEL=${LOG_LEVEL}
          NODE_ENV=${NODE_ENV}
          EOF
          grep -E '^[A-Z0-9_]+=.+$' /tmp/worker-secrets.env > /tmp/worker-secrets.filtered || true
          if [ -s /tmp/worker-secrets.filtered ]; then
            flyctl secrets import -a "$APP_NAME" < /tmp/worker-secrets.filtered
          else
            echo "No non-empty secrets/vars to import."
          fi

      - name: Deploy worker
        run: |
          bash scripts/deploy-worker-fly.sh

      - name: Smoke check worker
        run: |
          ok_machine=0
          for i in {1..24}; do
            if flyctl machine list -a "$APP_NAME" | grep -q "started"; then
              ok_machine=1
              break
            fi
            sleep 5
          done
          test "$ok_machine" -eq 1

          ok=0
          for i in {1..12}; do
            if flyctl logs -a "$APP_NAME" --no-tail | grep -Eq "Worker started, entering main loop|Stored whale snapshot|Running initial RSS backfill"; then
              ok=1
              break
            fi
            sleep 10
          done
          test "$ok" -eq 1
